<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="Content-Language" content="en-us">
		<title>Web Editor</title>
		<link rel="stylesheet" type="text/css" href="xtext/2.17.0/xtext-ace.css"/>
		<link rel="stylesheet" type="text/css" href="style.css"/>
		<link rel="stylesheet" type="text/css" href="./simulator-resources/index.css"/>

		<script src="webjars/requirejs/2.3.6/require.min.js"></script>


	</head>
	<body>
		<script type="text/javascript">
			var linesOfCode = [], lastFirstNumber = "-1", listGoTo=[];
			var baseUrl = window.location.pathname;
			var fileIndex = baseUrl.indexOf("index.html");
			if (fileIndex > 0)
				baseUrl = baseUrl.slice(0, fileIndex);

			// document.getElementById("myDIV").onscroll = function() {myFunction()};
			require.config({
				baseUrl: baseUrl,
				paths: {
					"jquery": "webjars/jquery/3.3.1-1/jquery.min",
					"ace/ext/language_tools": "webjars/ace/1.3.3/src/ext-language_tools",
					"xtext/xtext-ace": "xtext/2.17.0/xtext-ace"
				}
			});
			require(["webjars/ace/1.3.3/src/ace"], function() {
				require(["xtext/xtext-ace"], function(xtext) {
					editor = xtext.createEditor({
						baseUrl: baseUrl,
						syntaxDefinition: "xtext-resources/generated/mode-xdrone"
					});

					// var scroller = document.getElementsByClassName("ace_content");
					// console.log(scroller[0]);
					// scroller[0].onscroll = function() {console.log("INSCROLL");};


					$('#generate-button').bind("click", function(e)
						{
							var data =
							{
								resource : editor.xtextServices.options.resourceId,
								fullText : editor.getValue()
							};
							linesOfCode = editor.getValue().split(/\r\n|\r|\n/);
							listGoTo=[];
							$.post(baseUrl+'xtext-service/compile?resource='+editor.xtextServices.options.resourceId, data, function(result){
								console.log("resource generated", result);
								// console.log(require.undef);
								// require.undef('./simulator.js');
								// console.log(require.cache);
								// console.log(require.cache['./simulator.js']);
								// if(require.cache['./simulator.js'])
								// 	delete require.cache['./simulator.js']

								var pathSimulator = '', pathEnvironment = '';
								result.artifacts.forEach(a =>{
									if(a.name.includes('simulator'))
										pathSimulator = a.name.replace("DEFAULT_OUTPUTWebroot/", "")
									if(a.name.includes('environment'))
										pathEnvironment = a.name.replace("DEFAULT_OUTPUTWebroot/", "")
								})

								flySimulation = undefined;
								if(pathEnvironment && pathEnvironment != '')
									require(['./' + pathEnvironment], function(module){
										init();
										environment();
										require(['./' + pathSimulator], function(module){
										})
									})
								else
									init();
									require(['./' + pathSimulator], function(module){
									})

							});

							e.preventDefault();
						});

	 					$('#deploy-button').bind("click", function(e){
	 						var data = {
	 							resource : editor.xtextServices.options.resourceId,
	 							fullText : editor.getValue()
	 						};

	 						$.post(baseUrl+'xtext-service/compile?resource='+editor.xtextServices.options.resourceId, data, function(result){
								console.log("resource generated");

								console.log("deploying resource");

		 						$.post(baseUrl+'xtext-service/deploy?resource='+editor.xtextServices.options.resourceId, data, function(result){
		 							console.log("deployment finished");

								});
							});
							e.preventDefault();
	 					});


				});
			});

			function addGoToToEditor(){
				var lineNumbers = document.getElementsByClassName("ace_gutter-cell");
				if(lineNumbers && lineNumbers[0] && lastFirstNumber != lineNumbers[0].innerHTML){
					lastFirstNumber = lineNumbers[0].innerHTML;
					removeGoToChilds();

					for (var k = 0; k < listGoTo.length; k++) {
						for (var i = 0; i < linesOfCode.length; i++) {
							if(linesOfCode[i].includes('GOTO("' + listGoTo[k].object_name + '")')){ //'GOTO("' + listGoTo[k] + '"")')){
								for (var j = 0; j < lineNumbers.length; j++) {
									if(lineNumbers[j].innerHTML == i+1+""){
										var node = document.createElement("div");
										node.innerHTML = "&#8680;"
										node.classList.add("goto_div");

										var child = document.createElement("div");
										child.innerHTML=listGoTo[k].commands;
										child.classList.add("goto_div_child");
										node.appendChild(child);

										node.onclick = function(e) {
											console.log("CLICK", e.target.children[0]);
										    e.target.children[0].classList.toggle("show");
										};
										lineNumbers[j].appendChild(node);
									}
								}
							}
						}
					}
				}
			}

			function removeGoToChilds(){
				[...document.getElementsByClassName("goto_div")].map(n => n && n.remove());
			}
		</script>

		<div class="container">
			<!-- <div class="header">
				<h1>Web Editor</h1>
			</div> -->
			<button id="generate-button" value="Simulate" title="Generate">Simulate</button>
			<button id="deploy-button" value="Fly" title="Deploy">Fly</button>
			<div class="content">
				<div id="xtext-editor" data-editor-xtext-lang="xdrone"></div>
			</div>
		</div>

		<!-- Simulator -->
		<!-- <script src="./simulator-resources/three.js"></script> -->
		<!-- <script src="./simulator-resources/LegacyJSONLoader.js"></script>
		<script src="./simulator-resources/OrbitControls.js"></script> -->
		<script src="./simulator-resources/scene.js"></script>

		<div id="SIMULATOR_CONTAINER">
			<div id="SIMULATOR_OUTPUT">
			</div>
			<div id="SIMULATOR">
					<script>
						let THREE;
						require(['./simulator-resources/three.js'], function(moduleThree){
							THREE = moduleThree;
							require(['./simulator-resources/OrbitControls.js'], function(module){
								require(['./simulator-resources/LegacyJSONLoader.js'], function(module){
									init();
									animate();
								})
							})
						})
					</script>
			</div>
			<div id="AXES_SYSTEM">
			</div>
		</div>


	</body>
</html>
